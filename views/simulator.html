<!DOCTYPE>
<html>
	<head>
		<meta charset="utf-8" /> 
		<title>Innovators 2016: LED Cube Challenge</title>
		
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrap-material-design.css">
		<link rel="stylesheet" type="text/css" href="css/ripples.min.css">
		<link rel="stylesheet" type="text/css" href="css/snackbar.min.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">

		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/material.min.js"></script>
		<script type="text/javascript" src="js/ripples.min.js"></script>
		<script type="text/javascript" src="js/snackbar.min.js"></script>
		<script type="text/javascript" src="js/socket.io.js"></script>
		<style>
		body { 
			margin: 0;
			color: #fff;
			background: #000;
		} 
		canvas { 
			width: 100%;
			height: 100%;
		}
		#poweredby{
			background: url("img/logo.png") no-repeat;
			background-size: contain;
			position: absolute;
			right: 10px;
			bottom: 10px;
			display: block;
			width: 446px;
			height: 100px;
			/*pointer-events: none;*/
		}
		#challengeName{
			position: absolute;
			left: 20px;
			bottom: 0;
			display: block;
			width: 446px;
			height: 60pt;
			font-family: 'Open Sans', Sans serif, Arial;
			font-size: 30pt;
			font-weight: 300;
			color: #fff;
			/*pointer-events: none;*/
		}
		#display_timer{
			position: absolute;
			right: 20px;
			top: 20px;
			display: block;
			font-family: 'Open Sans', Sans serif, Arial;
			font-size: 16pt;
			text-align: right;
			font-weight: 300;
			color: #fff;
			/*pointer-events: none;*/
		}
		#display_timer i{
			margin-top: -2px;
			display: inline-block;
			vertical-align: middle;
		}
		#display_queue_content{
			position: absolute;
			right: 20px;
			top: 60px;
			display: block;
			font-family: 'Open Sans', Sans serif, Arial;
			font-size: 10pt;
			text-align: right;
			font-weight: 300;
			color: #fff;
		}
		#display_queue_content i{
			margin-top: -2px;
			display: inline-block;
			vertical-align: middle;
		}
		#patternList{
			background: url("img/ledcube.png") no-repeat 20px 20px;
			background-size: 80px;
			position: absolute;
			left: 0;
			top: 0;
			padding: 20px;
			padding-left: 110px;
			display: block;
			z-index: 1000;
			width: 500px;
			height: 120px;
			pointer-events: none;
			color: #fff;
			font-family: 'Open Sans', Sans serif, Arial;
			text-align: left;
			font-weight: 300;
		}
		#patternId{
			margin-top: 10px;
			font-size: 30pt;
			width: 1000px;
		}
		#patterns{
			margin-left: -60px;
			margin-top: 30px;
			border-left: #333 solid thin;
		}
		.patternItem{
			display: block;
			font-size: 13pt;
			padding: 5px 20px;
			border-left: #88f400 0px solid;
			background: rgba(136,244,0,0);
			transition: border-left .1s;
			width: 150px;
		}
		.patternItem.active{
			border-left: #88f400 10px solid;
			background: rgba(136,244,0,0.1);
		}
		</style>
		<script>

			var nextPattern = 0;
			var currentPattern = 0;
			var display_timerInterval;
			var display_timerCount = 10;

			var socket = io();

			$(document).ready(function(){
				$("#display_timer").hide();
				$("#display_queue_content").hide();

			});

			var display_queue = [];


			socket.on('request_pattern', function(data){
				if(display_queue.length > 10) return;
				nextPattern = data.id;
				if(nextPattern == currentPattern){
					return;
				}

				currentPattern = nextPattern;
				display_queue.push(nextPattern);
				$("#display_queue_content").fadeIn();
				$("#display_queue_content .text").text(JSON.stringify(display_queue));
				console.log(data);
				if(display_timerCount < 10) {
					return;
				}
				if($.inArray(nextPattern, [1,2,3,4,5,6,7,8,9,10])){
					display_startTimer();
					setTimeout(function(){
						setPattern(data.id);
						display_endTimer();
					}, 10000);
				}
			});


			function display_startTimer(){
				clearInterval(display_timerInterval);
				display_timerInterval = setInterval(function(){

					$("#display_timer").fadeIn();
					$("#display_timer").html('<i class="material-icons">timer</i> Changing to Pattern ' + nextPattern + ' in ' + (display_timerCount--) + 's...');
				}, 1000);
			}

			function display_endTimer(){
				clearInterval(display_timerInterval);
				display_timerCount = 10;

				display_queue.splice(0, 1);

				$("#display_timer").fadeOut();
				$("#display_queue_content").fadeOut();

				if(display_queue.length > 0){
					$("#display_queue_content").fadeIn();
					$("#display_queue_content span.text").text(JSON.stringify(display_queue));
					nextPattern = display_queue[0];
					if($.inArray(nextPattern, [1,2,3,4,5,6,7,8,9,10])){
						display_startTimer();
						setTimeout(function(){
							setPattern(nextPattern);
							display_endTimer();
						}, 10000);
					}
				} else {
					$("#display_queue_content").fadeOut();
				}
			}

		</script>
	</head>
	<body>
		<div id="poweredby"></div>
		<div id="display_timer"><i class="material-icons">timer</i> Changing to Pattern 3 in 10s...</div>
		<div id="display_queue_content"><i class="material-icons">queue_play_next</i> <span class="text"></span></div>
		<div id="challengeName">LED Cube Challenge</div>
		<div id="patternList">
			<div id="patternId">Pattern 1</div>
			<div id="patterns">
				<span class="patternItem pattern1 active">Pattern 1</span>
				<span class="patternItem pattern2">Pattern 2</span>
				<span class="patternItem pattern3">Pattern 3</span>
				<span class="patternItem pattern4">Pattern 4</span>
				<span class="patternItem pattern5">Pattern 5</span>
				<span class="patternItem pattern6">Pattern 6</span>
				<span class="patternItem pattern7">Pattern 7</span>
				<span class="patternItem pattern8">Pattern 8</span>
				<span class="patternItem pattern9">Pattern 9</span>
				<span class="patternItem pattern10">Pattern 10</span>
			</div>
		</div>
		<script src="js/three.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script> 

		var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );
		var renderer = new THREE.WebGLRenderer();



		var spacing = 2;
		var sphereScale = 0.6;
		var timerCount = 0;
		var timerInterval = 0.1; // seconds
		var idleRotationAmount = 0.005;

		// to track mouse movements
		var mouseX = 1, mouseY = 1;
		var last_mouseX = 1, last_mouseY = 1;
		var xDif = 1, yDif = 1;

		// to design patterns
		var light_i = 1, light_j = 0, light_k = 0;
		var currentIteration = 0;			// pattern iteration

		var transformObject = new THREE.Group();
		var circles = new THREE.Group();
		var geometry = new THREE.SphereGeometry(sphereScale,7,7);

		// UI controls
		var mouseMove_enabled = true;

		renderer.setSize( window.innerWidth, window.innerHeight );
		document.body.appendChild( renderer.domElement );

		scene.fog = new THREE.Fog( 0x000000, 5, spacing * 5 + 10 );

		for(var i=0; i<5; i++){
			for(var j=0; j<5; j++){
				for(var k=0; k<5; k++){
					var circle = new THREE.Mesh( geometry, new THREE.MeshBasicMaterial( { color: 0x333333 } ) );
					circle.position.x = i * spacing - spacing * 2;
					circle.position.y = -j * spacing + spacing * 2;
					circle.position.z = k * spacing - spacing * 2;
					circles.add(circle);
				}
			}
		}

		geometry_wireframe = new THREE.BoxGeometry( 8, 8, 8 );
		material_wireframe = new THREE.MeshBasicMaterial( { color: 0xff0000} );

		object_wireframe = new THREE.Mesh( geometry_wireframe, material_wireframe );
		edges_wireframe = new THREE.EdgesHelper( object_wireframe, 0x224422 );


		// circles.add( object_wireframe );
		circles.add( edges_wireframe );

		transformObject.add( circles );
		scene.add( transformObject );


		camera.position.z = 15;

		// console.log(transformObject.children[0].children[0].material.color.getHex());

		// direction = { 0:i , 1:j , 2:k }; id = {0,1,2}
		// sample usage::  turnOnRow(0,2);
		var turnOnRow = function(direction, id){	
			turnOffAll();

			for(var i=0; i<5; i++){
				for(var j=0; j<5; j++){
					for(var k=0; k<5; k++){
						var idx;
						if(direction == 0) idx = i*9 + j*5 + k;
						if(direction == 1) idx = j*9 + i*5 + j;
						if(direction == 2) idx = k*9 + j*5 + i;
						if(direction == 0 && ((idx%5)%id)==0) transformObject.children[0].children[idx].material.color.setHex(0xff3344);
						if(direction == 1 && ((idx%5)%id)==0) transformObject.children[0].children[idx].material.color.setHex(0xff3344);
						if(direction == 2 && ((idx%5)%id)==0) transformObject.children[0].children[idx].material.color.setHex(0xff3344);
					}
				}
			}
		}
		var turnOffAll = function(){
			for(var i=0; i<5; i++){
				for(var j=0; j<5; j++){
					for(var k=0; k<5; k++){
						var idx = i*25 + j*5 + k;
						transformObject.children[0].children[idx].material.color.setHex(0x333333);
					}
				}
			}
		}
		var turnOnAll = function(){
			for(var i=0; i<5; i++){
				for(var j=0; j<5; j++){
					for(var k=0; k<5; k++){
						var idx = i*25 + j*5 + k;
						transformObject.children[0].children[idx].material.color.setHex(0xff3344);
					}
				}
			}
		}

 		// get patterns from file saved as patternName.json
 		var setPattern = function (id){
 			if(id==0) {
 				$("#patternId").text("Pattern 10");
 				$(".patternItem").removeClass("active");
 				$(".patternItem.pattern10").addClass("active");
 				getJsonPattern("pattern" + 10);

 			} else {
 				$("#patternId").text("Pattern " + id);
 				$(".patternItem").removeClass("active");
 				$(".patternItem.pattern" + id).addClass("active");
 				getJsonPattern("pattern" + id);
 				// console.log("creating JSON pattern..");
 			}

 		}
		var getJsonPattern = function(patternName){
			$.getJSON(patternName+".json", function(json) {
			// $.getJSON("pattern3.json", function(json) {
			    prepareJSONdata(json);
			});
		}

		var current_jsonPattern = [];
		var current_jsonPattern_id = 0;
		var jsonFile;

		var playCurrentJsonPattern = function(){
			if(current_jsonPattern == undefined) {
				prepareJSONdata(jsonFile);
				return;
			}
			for(var i=0; i<125; i++){
				// console.log(current_jsonPattern[i]);
				if(current_jsonPattern[i+1] == 1) {
					transformObject.children[0].children[i].material.color.setHex(0xff3344);
				}
			}
			prepareJSONForNextIteration();
		}

		var prepareJSONdata = function(json){

			current_jsonPattern = json.pattern[current_jsonPattern_id++]
			if(current_jsonPattern_id >= json.length){
				current_jsonPattern_id = 0;
			}
			jsonFile = json;
		}

		var prepareJSONForNextIteration = function(){
			current_jsonPattern = Object.values(jsonFile.pattern)[current_jsonPattern_id++]
			if(current_jsonPattern_id >= jsonFile.length){
				current_jsonPattern_id = 0;
			}
		}

		var changeColor = function (){

			for(var i=0; i<5; i++){
				for(var j=0; j<5; j++){
					for(var k=0; k<5; k++){
						var idx = i*25 + j*5 + k;
						transformObject.children[0].children[idx].material.color.setHex(0x333333);
					}
				}
			}

			for(var i=0; i<5; i++){
				for(var j=0; j<5; j++){
					for(var k=0; k<5; k++){
						var idx = i*25 + j*5 + k;
						if(light_i == 1 && ((idx%5)==currentIteration)) transformObject.children[0].children[idx].material.color.setHex(0xff3344);
					}
				}
			}
			currentIteration++;
			if(currentIteration == 5){
				currentIteration = 0;
			}
		}

		var render = function () { 

			requestAnimationFrame( render );
			if(mouseMove_enabled){
				transformObject.children[0].rotation.x += idleRotationAmount + (last_mouseY - transformObject.children[0].rotation.x) * 0.2;
				transformObject.children[0].rotation.y += idleRotationAmount + (last_mouseX - transformObject.children[0].rotation.y) * 0.1;
			} else {
				transformObject.children[0].rotation.x += idleRotationAmount;
				transformObject.children[0].rotation.y += idleRotationAmount;
			}
			renderer.render(scene, camera);
			timerCount++;
			if(timerCount == timerInterval * 60){
				timerCount = 0;
				turnOffAll();
				playCurrentJsonPattern(); ///changeColor();
			}
			xDif = Math.abs((mouseX - last_mouseX));
			yDif = Math.abs((mouseY - last_mouseY));
			last_mouseX = mouseX * 0.005;
			last_mouseY = mouseY * 0.005;

		};
		render();
		getJsonPattern("pattern1");

		$(document).mousemove( function(e){
			mouseX = e.clientX;
			mouseY = e.clientY;
		});
		$(document).keyup( function(e){
			// console.log(e.keyCode);
			if(e.keyCode == 32){
				mouseMove_enabled = !mouseMove_enabled;
			} else if (e.keyCode >= 48 && e.keyCode <= 57){
				setPattern(e.keyCode - 48);
			}
		});

		</script>

	</body>
</html>